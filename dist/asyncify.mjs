const t=16,e=new WeakMap;class s{constructor(){this.state={type:"Loading"},this.exports=null}invalidState(){throw new Error(`Invalid async state ${this.state.type}`)}reset(){this.state={type:"None"}}wrapImportFn(e){return(...s)=>{switch(this.state.type){case"None":{let n=e(...s);return function(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then}(n)?(this.exports.asyncify_start_unwind(t),this.state={type:"Unwinding",promise:n},0):n}case"Rewinding":{let{value:t}=this.state;return this.reset(),this.exports.asyncify_stop_rewind(),t}default:this.invalidState()}}}wrapModuleImports(t){let e={};for(let s in t){let n=t[s];"function"==typeof n&&(n=this.wrapImportFn(n)),e[s]=n}return e}wrapImports(t){if(void 0===t)return;let e={};for(let s in t)e[s]=this.wrapModuleImports(t[s]);return e}wrapExportFn(s){let n=e.get(s);return void 0!==n?n:(n=async(...e)=>{"None"!==this.state.type&&this.invalidState();let n=s(...e);for(;"Unwinding"===this.state.type;){let e,{promise:r}=this.state;this.reset(),this.exports.asyncify_stop_unwind(),this.state={type:"Waiting"};try{e=await r}finally{this.reset()}this.exports.asyncify_start_rewind(t),this.state={type:"Rewinding",value:e},n=s()}return"None"!==this.state.type&&this.invalidState(),n},e.set(s,n),n)}wrapExports(t){let s=e.get(t);if(void 0!==s)return s;s=Object.create(null);for(let e in t){let n=t[e];"function"!=typeof n||e.startsWith("asyncify_")||(n=this.wrapExportFn(n)),Object.defineProperty(s,e,{enumerable:!0,value:n})}return e.set(t,s),s}init(e){const{exports:s}=e,r=new Int32Array(s.memory.buffer,t);r[0]=t+8,r[1]=512,this.reset(),this.exports=this.wrapExports(s),Object.setPrototypeOf(e,n.prototype)}}class n extends WebAssembly.Instance{constructor(t,e){let n=new s;super(t,n.wrapImports(e)),n.init(this)}get exports(){return e.get(super.exports)}}async function r(t,e){let n=new s,r=await WebAssembly.instantiate(t,n.wrapImports(e));return n.init(r.instance),r}async function i(t,e){let n=new s,r=await WebAssembly.instantiateStreaming(t,n.wrapImports(e));return n.init(r.instance),r}Object.defineProperty(n.prototype,"exports",{enumerable:!0});export{n as Instance,r as instantiate,i as instantiateStreaming};
